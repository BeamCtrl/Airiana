<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>WiFi Configuration</title>
    <style>
        #networks { line-height: 1.2em; }
        select, input { margin-top: 5px; margin-bottom: 5px; }
    </style>
</head>
<body>
    <p>
        Airiana Wi-Fi access point.<br>
        Select your network and fill in your password, then press Configure.<br>
        The Airiana box will reboot when configuring WiFi.
    </p>

    <a>Choose your home Wi-Fi network:</a><br>
    <div id="networks">Loading Wi-Fi access points… Please wait</div>
    <img src="airiana_wifi.png" alt="Description of image" width="500" height="300">

    <script>
        const pollingInterval = 10000; // 10 seconds
        let ssidRequest = null;

        function fetchSSIDs() {
            // Abort previous request if still running
            if (ssidRequest) {
                ssidRequest.abort();
                console.log("Aborted previous SSID request");
            }

            ssidRequest = new XMLHttpRequest();
            ssidRequest.timeout = 5000;

            const url = "/SSID"; // guaranteed valid
            console.log("Opening XHR to:", url);

            ssidRequest.onreadystatechange = function() {
                if (ssidRequest.readyState === 4) {
                    if (ssidRequest.status === 200) {
                        renderSSIDs(ssidRequest.responseText);
                    } else {
                        console.warn("SSID request failed or aborted", ssidRequest.status);
                    }
                    ssidRequest = null;
                }
            };

            ssidRequest.ontimeout = function() {
                console.warn("SSID request timed out");
                ssidRequest = null;
            };

            ssidRequest.open("GET", url, true);
            ssidRequest.send();
        }

        function renderSSIDs(responseText) {
            const raw = [...responseText.matchAll(/ESSID:(?:"([^"]+)"|(\S+))/g)].map(m => m[1] || m[2]);
            const ssids = raw.filter(ssid => ssid !== '""');
            console.log(ssids);
            const container = document.getElementById("networks");

            // Clear previous content
            container.innerHTML = "";

            // Create form
            const form = document.createElement("form");
            form.name = "wifiForm";

            // Build a fully qualified action URL
            const host = window.location.hostname || "192.168.1.61"; // fallback
            const port = "8000";
            form.action = `http://${host}:${port}/setup`;
            form.method = "POST";

            // Create select box
            const select = document.createElement("select");
            select.name = "network";

            if (ssids.length === 0) {
                const option = document.createElement("option");
                option.textContent = "Loading Wi-Fi access points… Please wait";
                select.appendChild(option);
            } else {
                ssids.forEach(ssid => {
                    const option = document.createElement("option");
                    option.value = ssid;
                    option.textContent = ssid;
                    select.appendChild(option);
                });
            }

            form.appendChild(select);
            form.appendChild(document.createElement("br"));

            // Password input and submit
            if (ssids.length > 0) {
                const label = document.createElement("label");
                label.htmlFor = "password";
                label.textContent = "Password:";
                form.appendChild(label);

                const input = document.createElement("input");
                input.type = "password";
                input.id = "password";
                input.name = "Password";
                input.required = true;
                form.appendChild(document.createElement("br"));
                form.appendChild(input);

                const submit = document.createElement("input");
                submit.type = "submit";
                submit.value = "Configure";
                form.appendChild(document.createElement("br"));
                form.appendChild(submit);
            }

            container.appendChild(form);
        }

        // Initial fetch
        fetchSSIDs();
        // Poll every 10 seconds
        setInterval(fetchSSIDs, pollingInterval);
    </script>
</body>
</html>
